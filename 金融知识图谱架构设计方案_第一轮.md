# 金融知识图谱架构设计方案 - 第一轮

## 1. 项目概述

### 1.1 需求分析

基于用户需求，本项目需要构建一个金融领域的知识图谱系统，具备以下核心功能：
- **实体挖掘**：识别金融文本中的实体（公司、人物、机构等）
- **实体关系**：挖掘实体间的语义关系（投资关系、竞争关系、合作等）
- **实体关键事件**：识别与实体相关的重要事件（并购、上市、重组等）
- **例行化处理**：自动聚合重复语义关系名称，处理相似实体去重

### 1.2 技术要求
- **部署模式**：单机部署，单进程运行
- **开发框架**：FastAPI（异步Web框架）
- **AI集成**：LangChain + LangGraph + 大模型抽取
- **数据库**：SQLite3
- **环境**：中文环境

## 2. 系统架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        金融知识图谱系统                          │
├─────────────────┬───────────────┬─────────────────┬─────────────┤
│   数据采集模块    │   数据处理模块   │   图谱构建模块    │  API服务模块 │
├─────────────────┼───────────────┼─────────────────┼─────────────┤
│                 │               │                 │             │
│ ┌─────────────┐ │ ┌───────────┐ │ ┌─────────────┐ │ ┌─────────┐ │
│ │  爬虫引擎   │ │ │ 正文提取   │ │ │ 实体关系抽取 │ │ │ FastAPI │ │
│ └─────────────┘ │ └───────────┘ │ └─────────────┘ │ └─────────┘ │
│                 │               │                 │             │
│ ┌─────────────┐ │ ┌───────────┐ │ ┌─────────────┐ │ ┌─────────┐ │
│ │ 调度器管理  │ │ │ 语义理解   │ │ │  事件识别    │ │ │ 管理界面│ │
│ └─────────────┘ │ └───────────┘ │ └─────────────┘ │ └─────────┘ │
├─────────────────┼───────────────┼─────────────────┼─────────────┤
│               数据层（SQLite3 + 文件存储）                     │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件说明

#### 2.2.1 数据采集模块
- **爬虫引擎**：使用aiohttp + asyncio实现异步爬虫
- **调度器管理**：基于APScheduler的任务调度系统
- **数据存储**：原始HTML和URL信息存储

#### 2.2.2 数据处理模块
- **正文提取**：基于readability的智能正文提取
- **文本预处理**：中文分词、词性标注、实体识别
- **语义理解**：基于预训练中文模型的语义分析

#### 2.2.3 图谱构建模块
- **实体关系抽取**：基于LangChain + 大模型的实体关系抽取
- **事件识别**：金融事件自动识别和分类
- **关系聚合**：基于语义相似度自动聚合重复关系
- **实体去重**：基于多特征相似度的实体去重

#### 2.2.4 API服务模块
- **FastAPI**：异步RESTful API服务
- **查询接口**：实体查询、关系查询、事件查询
- **管理界面**：基于Web的管理控制台

## 3. 技术架构详细设计

### 3.1 技术栈选择

| 技术组件 | 技术选择 | 版本建议 | 用途 |
|---------|---------|---------|------|
| Web框架 | FastAPI | ≥0.104.0 | 异步API服务 |
| 数据库 | SQLite3 | 内置 | 关系型数据存储 |
| 爬虫框架 | aiohttp + asyncio | ≥3.9.0 | 异步网页爬取 |
| 分词工具 | jieba | ≥0.42.1 | 中文分词 |
| AI框架 | LangChain | ≥0.0.300 | 大模型集成 |
| 工作流框架 | LangGraph | 最新版 | AI工作流管理 |
| 任务调度 | APScheduler | ≥3.10.0 | 定时任务管理 |
| 数据提取 | readability-lxml | ≥0.8.1 | 网页正文提取 |
| 数据验证 | Pydantic | ≥2.4.0 | 数据模型验证 |

### 3.2 数据模型设计

#### 3.2.1 核心表结构

**实体表 (entities)**
```sql
CREATE TABLE entities (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    name_aliases TEXT, -- JSON格式存储别名列表
    entity_type TEXT NOT NULL, -- 公司、个人、机构、行业等
    industry TEXT, -- 行业分类
    region TEXT, -- 地区信息
    confidence_score REAL DEFAULT 0.0, -- 实体置信度
    attributes TEXT, -- JSON格式存储实体属性
    source_count INTEGER DEFAULT 1, -- 来源文档数量
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT 0
);
```

**关系表 (relations)**
```sql
CREATE TABLE relations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    source_entity_id INTEGER NOT NULL,
    target_entity_id INTEGER NOT NULL,
    relation_type TEXT NOT NULL, -- 投资、竞争、合作等
    relation_subtype TEXT, -- 关系子类型
    confidence_score REAL DEFAULT 0.0, -- 关系置信度
    attributes TEXT, -- JSON格式存储关系属性
    evidence_text TEXT, -- 支撑文本
    source_document_id INTEGER, -- 来源文档ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT 0,
    FOREIGN KEY (source_entity_id) REFERENCES entities(id),
    FOREIGN KEY (target_entity_id) REFERENCES entities(id)
);
```

**事件表 (events)**
```sql
CREATE TABLE events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    description TEXT,
    event_type TEXT NOT NULL, -- 财务事件、并购事件、人事变动等
    event_subtype TEXT, -- 事件子类型
    occurred_date DATE, -- 事件发生日期
    affected_entities TEXT, -- JSON格式存储受影响实体ID列表
    impact_level TEXT, -- 影响级别（高、中、低）
    confidence_score REAL DEFAULT 0.0, -- 事件置信度
    source_document_id INTEGER, -- 来源文档ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT 0
);
```

**源文档表 (source_documents)**
```sql
CREATE TABLE source_documents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    url TEXT NOT NULL UNIQUE,
    title TEXT,
    content TEXT, -- 提取的正文内容
    published_date TIMESTAMP, -- 文档发布时间
    crawled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processing_status TEXT DEFAULT 'pending', -- pending, processing, completed, failed
    entity_count INTEGER DEFAULT 0,
    relation_count INTEGER DEFAULT 0,
    event_count INTEGER DEFAULT 0,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**实体去重映射表 (entity_deduplication)**
```sql
CREATE TABLE entity_deduplication (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    primary_entity_id INTEGER NOT NULL, -- 主实体ID
    duplicate_entity_id INTEGER NOT NULL, -- 被合并的实体ID
    similarity_score REAL NOT NULL, -- 相似度分数
    merge_type TEXT NOT NULL, -- merge_type: name_similarity, attribute_match, contextual
    confidence_level TEXT, -- high, medium, low
    manual_review BOOLEAN DEFAULT 0, -- 是否需要人工审核
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (primary_entity_id) REFERENCES entities(id),
    FOREIGN KEY (duplicate_entity_id) REFERENCES entities(id)
);
```

**关系聚合表 (relation_aggregation)**
```sql
CREATE TABLE relation_aggregation (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    original_relation_type TEXT NOT NULL, -- 原始关系类型
    aggregated_relation_type TEXT NOT NULL, -- 聚合后的关系类型
    similarity_threshold REAL DEFAULT 0.8, -- 相似度阈值
    sample_entities TEXT, -- JSON格式存储示例实体
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.3 系统模块设计

#### 3.3.1 异步爬虫模块

```python
# 核心组件
class AsyncCrawler:
    - 异步HTTP请求处理
    - 智能解析和正文提取
    - 反爬虫策略
    - 数据清洗和预处理

class CrawlerScheduler:
    - URL调度管理
    - 任务优先级控制
    - 失败重试机制
    - 爬取状态监控
```

#### 3.3.2 自然语言处理模块

```python
# 核心组件
class ChineseNLPProcessor:
    - 中文分词和词性标注
    - 命名实体识别（NER）
    - 句法分析
    - 语义角色标注

class FinancialEntityExtractor:
    - 金融领域实体识别
    - 实体消歧和标准化
    - 实体属性抽取
    - 实体置信度计算
```

#### 3.3.3 大模型集成模块

```python
# 核心组件
class LLMProcessor:
    - LangChain模型集成
    - LangGraph工作流管理
    - Prompt工程优化
    - 结果后处理

class EntityRelationExtractor:
    - 实体关系抽取提示设计
    - 关系类型标准化
    - 关系置信度评估
    - 关系属性填充

class EventRecognizer:
    - 事件识别和分类
    - 时间信息抽取
    - 事件影响评估
    - 事件关联分析
```

#### 3.3.4 图谱构建模块

```python
# 核心组件
class GraphBuilder:
    - 实体图谱构建
    - 关系图谱构建
    - 事件图谱构建
    - 图谱质量评估

class EntityDeduplicator:
    - 实体相似度计算
    - 实体去重算法
    - 实体合并策略
    - 关系迁移处理

class RelationAggregator:
    - 关系类型聚类
    - 语义相似度计算
    - 关系名称标准化
    - 聚合规则管理
```

## 4. 业务流程设计

### 4.1 数据处理流程

```
爬虫抓取 -> 正文提取 -> NLP预处理 -> 大模型抽取 -> 关系聚合 -> 实体去重 -> 图谱更新
    ↓           ↓           ↓           ↓           ↓           ↓           ↓
  任务调度    文本清洗    中文分词    实体识别    关系聚类    相似度计算   数据持久化
```

### 4.2 核心处理步骤

1. **数据采集阶段**
   - 调度器定时触发爬虫任务
   - 异步爬虫抓取指定URL
   - 智能提取网页正文内容
   - 数据预处理和清洗

2. **信息抽取阶段**
   - 中文文本分词和实体识别
   - 基于大模型的实体关系抽取
   - 金融事件自动识别
   - 置信度评估和结果过滤

3. **数据处理阶段**
   - 重复语义关系聚合
   - 相似实体去重和合并
   - 实体属性标准化
   - 数据一致性检查

4. **图谱构建阶段**
   - 构建实体关系网络
   - 更新图谱数据
   - 索引重建
   - 质量评估

## 5. 部署和运维设计

### 5.1 部署要求

- **操作系统**：Linux/macOS/Windows
- **Python版本**：≥3.9
- **内存要求**：≥4GB RAM
- **存储要求**：≥20GB可用空间
- **网络要求**：能够访问互联网获取新闻数据

### 5.2 配置管理

```python
# 配置文件结构
config/
├── database.json      # 数据库配置
├── crawler.json       # 爬虫配置
├── nlp.json          # NLP处理配置
├── llm.json          # 大模型配置
├── api.json          # API服务配置
└── scheduler.json    # 调度器配置
```

### 5.3 监控和日志

- **系统监控**：CPU、内存、磁盘使用率监控
- **性能监控**：爬虫速度、抽取成功率、API响应时间
- **错误处理**：异常捕获、重试机制、错误日志
- **数据质量**：实体完整性、关系准确性、事件识别率

## 6. 总结

本第一轮设计提供了一个完整的金融知识图谱系统架构，采用了异步框架FastAPI，集成了LangChain和LangGraph进行大模型处理，使用SQLite3作为数据存储，具备实体挖掘、关系构建、事件识别和例行化处理等核心功能。系统设计考虑了中文环境特点和单机部署要求。

设计要点：
- ✅ 异步框架设计，提升并发性能
- ✅ 中文环境适配，优化NLP处理
- ✅ 大模型集成，支持智能信息抽取
- ✅ 关系聚合算法，自动处理重复关系
- ✅ 实体去重机制，保持图谱质量
- ✅ 模块化设计，便于维护和扩展

该方案为后续的优化和改进提供了坚实的基础架构。