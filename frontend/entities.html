<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实体管理 - 知识图谱</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8rem; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        .nav-links a:hover { background: rgba(255,255,255,0.2); }
        .main-content { padding: 30px 0; }
        .search-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .search-form {
            display: grid;
            grid-template-columns: 1fr 200px 120px;
            gap: 15px;
            align-items: end;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-label { margin-bottom: 8px; font-weight: 500; color: #374151; }
        .form-control {
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        .btn-secondary:hover { background: #e5e7eb; }
        .entities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .entity-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .entity-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        .entity-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .entity-name { font-size: 1.1rem; font-weight: 600; color: #1f2937; }
        .entity-type {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .entity-desc {
            color: #6b7280;
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .entity-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .error { background: #fef2f2; color: #dc2626; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .success { background: #f0fdf4; color: #16a34a; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        .empty-state h3 { margin-bottom: 10px; color: #374151; }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 30px;
        }
        .page-btn {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .page-btn:hover { border-color: #667eea; color: #667eea; }
        .page-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .entity-detail {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .detail-title { font-size: 1.5rem; color: #1f2937; }
        .detail-section { margin-bottom: 25px; }
        .detail-section h3 { color: #374151; margin-bottom: 10px; font-size: 1.1rem; }
        .news-item {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin-bottom: 15px;
        }
        .news-title { font-weight: 600; color: #1f2937; margin-bottom: 5px; }
        .news-summary { color: #6b7280; font-size: 0.9rem; line-height: 1.4; }
        .news-date { color: #9ca3af; font-size: 0.8rem; margin-top: 5px; }
        
        @media (max-width: 768px) {
            .search-form { grid-template-columns: 1fr; }
            .entities-grid { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; gap: 15px; }
            .nav-links { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <h1>实体管理</h1>
                <nav class="nav-links">
                    <a href="index.html">首页</a>
                    <a href="content.html">内容处理</a>
                    <a href="graph.html">图谱可视化</a>
        
                </nav>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <!-- 搜索区域 -->
            <div class="search-section">
                <div class="search-form">
                    <div class="form-group">
                        <label class="form-label">搜索关键词</label>
                        <input type="text" id="searchKeyword" class="form-control" placeholder="输入实体名称或描述关键词" onkeyup="handleSearchEnter(event)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">实体类型</label>
                        <select id="entityType" class="form-control">
                            <option value="">全部类型</option>
                            <option value="人物">人物</option>
                            <option value="组织">组织</option>
                            <option value="地点">地点</option>
                            <option value="事件">事件</option>
                            <option value="产品">产品</option>
                            <option value="概念">概念</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                        <button class="btn btn-primary" onclick="searchEntities()">搜索</button>
                        <button class="btn btn-secondary" onclick="resetSearch()">重置</button>
                    </div>
                </div>
            </div>

            <!-- 结果区域 -->
            <div id="entities-container">
                <div class="loading">正在加载实体数据...</div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const API_BASE = API_CONFIG.BASE_URL;
        let currentPage = 1;
        let pageSize = 12;
        let totalEntities = 0;
        let currentView = 'list'; // list or detail
        let currentEntityId = null;

        // 搜索实体
        async function searchEntities() {
            try {
                showLoading();
                
                const params = {
                    page: currentPage,
                    page_size: pageSize,
                    search: document.getElementById('searchKeyword').value.trim() || undefined,
                    entity_type: document.getElementById('entityType').value || undefined
                };
                
                const result = await apiGet('/api/kg/entities', params);
                
                totalEntities = result.total || 0;
                displayEntities(result.items || []);
                displayPagination();
                
            } catch (error) {
                showError('实体查询失败: ' + error.message);
            }
        }

        // 显示实体列表
        function displayEntities(entities) {
            const container = document.getElementById('entities-container');
            
            if (entities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>未找到相关实体</h3>
                        <p>尝试调整搜索条件或创建新的内容</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="entities-grid">';
            entities.forEach(entity => {
                html += `
                    <div class="entity-card" onclick="showEntityDetail('${entity.id}')">
                        <div class="entity-header">
                            <div class="entity-name">${entity.name}</div>
                            <div class="entity-type">${entity.entity_type}</div>
                        </div>
                        <div class="entity-desc">${entity.description || '暂无描述'}</div>
                        <div class="entity-meta">
                            <span>ID: ${entity.id}</span>
                            <span>${formatDate(entity.created_at)}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // 显示实体详情
        async function showEntityDetail(entityId) {
            try {
                showLoading();
                currentEntityId = entityId;
                currentView = 'detail';
                
                const [detail, newsResult] = await Promise.all([
                    apiGet(`/api/kg/entities/${entityId}`),
                    apiGet(`/api/kg/entities/${entityId}/news`, { page: 1, page_size: 5 })
                ]);
                
                displayEntityDetail(detail, newsResult.items || []);
                
            } catch (error) {
                showError('获取实体详情失败: ' + error.message);
                currentView = 'list';
                searchEntities();
            }
        }

        // 显示实体详情
        function displayEntityDetail(entity, news) {
            const container = document.getElementById('entities-container');
            
            let html = `
                <div class="entity-detail">
                    <div class="detail-header">
                        <div class="detail-title">${entity.name}</div>
                        <button class="btn btn-secondary" onclick="backToList()">返回列表</button>
                    </div>
                    
                    <div class="detail-section">
                        <h3>基本信息</h3>
                        <p><strong>类型:</strong> ${entity.entity_type}</p>
                        <p><strong>描述:</strong> ${entity.description || '暂无描述'}</p>
                        <p><strong>创建时间:</strong> ${formatDate(entity.created_at)}</p>
                        <p><strong>更新时间:</strong> ${formatDate(entity.updated_at)}</p>
                    </div>
            `;
            
            if (news.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3>相关新闻</h3>
                        ${news.map(item => `
                            <div class="news-item">
                                <div class="news-title">${item.title}</div>
                                <div class="news-summary">${item.summary}</div>
                                <div class="news-date">${formatDate(item.published_at)}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // 返回列表
        function backToList() {
            currentView = 'list';
            currentEntityId = null;
            searchEntities();
        }

        // 显示分页
        function displayPagination() {
            const totalPages = Math.ceil(totalEntities / pageSize);
            const container = document.getElementById('entities-container');
            
            if (totalPages <= 1) return;
            
            let html = '<div class="pagination">';
            
            // 上一页
            html += `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">上一页</button>`;
            
            // 页码
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }
            
            // 下一页
            html += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">下一页</button>`;
            
            html += '</div>';
            
            container.innerHTML += html;
        }

        // 切换页面
        function changePage(page) {
            const totalPages = Math.ceil(totalEntities / pageSize);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                searchEntities();
            }
        }

        // 重置搜索
        function resetSearch() {
            document.getElementById('searchKeyword').value = '';
            document.getElementById('entityType').value = '';
            currentPage = 1;
            searchEntities();
        }

        // 处理搜索回车
        function handleSearchEnter(event) {
            if (event.key === 'Enter') {
                currentPage = 1;
                searchEntities();
            }
        }

        // API请求函数
        async function apiGet(endpoint, params = {}) {
            const url = new URL(API_BASE + endpoint);
            Object.keys(params).forEach(key => {
                if (params[key] !== undefined && params[key] !== '') {
                    url.searchParams.append(key, params[key]);
                }
            });
            
            const response = await fetch(url.toString());
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return await response.json();
        }

        // 工具函数
        function showLoading() {
            document.getElementById('entities-container').innerHTML = '<div class="loading">正在加载数据...</div>';
        }

        function showError(message) {
            document.getElementById('entities-container').innerHTML = `<div class="error">${message}</div>`;
        }

        function formatDate(dateString) {
            if (!dateString) return '未知';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            searchEntities();
        });
    </script>
</body>
</html>